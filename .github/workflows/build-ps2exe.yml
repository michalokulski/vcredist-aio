name: Build PS2EXE Installer

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PS2EXE
        shell: pwsh
        run: |
          Install-Module ps2exe -Scope CurrentUser -Force

      - name: Ensure required files are present
        shell: pwsh
        run: |
          if (-not (Test-Path automation/install.ps1)) {
            Write-Error "install.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }
          if (-not (Test-Path automation/uninstall.ps1)) {
            Write-Error "uninstall.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }

      - name: Ensure packages.json is present
        shell: pwsh
        run: |
          if (-not (Test-Path ./packages.json)) {
            Write-Error "packages.json is missing. Ensure it is committed to the repository."
            exit 1
          }

      - name: Debug workspace
        shell: pwsh
        run: |
          Write-Host "Current directory contents:"
          Get-ChildItem -Recurse

      - name: Debug packages.json path
        shell: pwsh
        run: |
          $packagesFile = (Resolve-Path ./packages.json).Path
          Write-Host "Resolved packages.json path: $packagesFile"

      # NOTE: package preparation is handled inside build-ps2exe.ps1 (it will reuse dist/packages if present)

      - name: Debug PowerShell Context
        shell: pwsh
        run: |
          Write-Host "PowerShell Version:"
          $PSVersionTable
          Write-Host "Current Directory:"
          Get-Location

      - name: Debug build-ps2exe.ps1
        shell: pwsh
        run: |
          Write-Host "Contents of build-ps2exe.ps1:"
          Get-Content ./automation/build-ps2exe.ps1 -Head 20

      - name: Build EXE using PS2EXE
        shell: pwsh
        run: |
          Write-Host "Running PS2EXE build script..."
          $scriptPath = (Resolve-Path ./automation/build-ps2exe.ps1).Path
          $packagesFile = (Resolve-Path ./packages.json).Path
          $outputDir = (Resolve-Path ./dist -ErrorAction SilentlyContinue).Path
          if (-not $outputDir) { New-Item -ItemType Directory -Path ./dist | Out-Null; $outputDir = (Resolve-Path ./dist).Path }
          Write-Host "Invoking: & $scriptPath -PackagesFile $packagesFile -OutputDir $outputDir -VerboseBuild"
          & $scriptPath -PackagesFile $packagesFile -OutputDir $outputDir -VerboseBuild

      - name: Compute EXE metadata and set outputs
        id: compute-metadata
        shell: pwsh
        run: |
          $exePath = (Resolve-Path ./dist/vcredist-aio.exe -ErrorAction Stop).Path
          $hash = (Get-FileHash -Algorithm SHA256 -Path $exePath).Hash
          $short = $hash.Substring(0,12)
          $sizeBytes = (Get-Item $exePath).Length
          $sizeMB = [math]::Round($sizeBytes / 1MB, 2)
          # Expose values to subsequent steps / jobs
          Write-Host "exe_sha=$hash" >> $env:GITHUB_OUTPUT
          Write-Host "exe_sha_short=$short" >> $env:GITHUB_OUTPUT
          Write-Host "exe_size_bytes=$sizeBytes" >> $env:GITHUB_OUTPUT
          Write-Host "exe_size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
          Write-Host "exe_path=$exePath" >> $env:GITHUB_OUTPUT
          Write-Host "Computed EXE metadata: SHA256=$hash, Size=${sizeMB}MB"

      - name: Validate build artifacts
        shell: pwsh
        run: |
          $files = @('dist/vcredist-aio.exe', 'dist/SHA256.txt')
          foreach ($f in $files) {
            if (-not (Test-Path $f)) {
              Write-Error "Required artifact missing: $f"
              exit 1
            }
          }
          Write-Host "âœ” All required artifacts present"

      - name: Upload SHA256SUMS.txt as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: dist/SHA256SUMS.txt
          if-no-files-found: error

      - name: Read SHA256SUMS into output
        id: read-sums
        shell: pwsh
        run: |
          $sumsPath = (Resolve-Path ./dist/SHA256SUMS.txt -ErrorAction Stop).Path
          $content = Get-Content -Raw -Path $sumsPath
          # Set multiline output 'sums'
          Write-Host "sums<<EOF" >> $env:GITHUB_OUTPUT
          Write-Host $content >> $env:GITHUB_OUTPUT
          Write-Host "EOF" >> $env:GITHUB_OUTPUT

      - name: Create Release (attach EXE + SHA256SUMS)
        if: always()
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Prefer computed short SHA, fallback to run number when empty
          tag_name: vcredist-aio-${{ steps.compute-metadata.outputs.exe_sha_short || github.run_number }}
          name: VCRedist AIO ${{ steps.compute-metadata.outputs.exe_sha_short || github.run_number }}
          files: |
            dist/vcredist-aio.exe
            dist/SHA256SUMS.txt
          body: |
            ## VCRedist AIO Offline EXE
            - File: dist/vcredist-aio.exe
            - SHA256: ${{ steps.compute-metadata.outputs.exe_sha }}
            - Size: ${{ steps.compute-metadata.outputs.exe_size_mb }} MB

            ### SHA256SUMS
            ${{ steps.read-sums.outputs.sums }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vcredist-aio
          path: |
            dist/vcredist-aio.exe
            dist/SHA256.txt
          if-no-files-found: error
