name: Build PS2EXE Installer

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PS2EXE module
        shell: pwsh
        run: |
          Install-Module ps2exe -Scope CurrentUser -Force

      - name: Ensure required files are present
        shell: pwsh
        run: |
          if (-not (Test-Path automation/install.ps1)) {
            Write-Error "install.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }
          if (-not (Test-Path automation/uninstall.ps1)) {
            Write-Error "uninstall.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }
          if (-not (Test-Path ./packages.json)) {
            Write-Error "packages.json is missing. Ensure it is committed to the repository."
            exit 1
          }

      - name: Debug workspace (optional)
        shell: pwsh
        run: |
          Write-Host "Current directory contents:"
          Get-ChildItem -Recurse

      - name: Build EXE using PS2EXE (single downloader)
        id: build
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Running PS2EXE build script (will download packages if needed)..."
          $scriptPath = (Resolve-Path ./automation/build-ps2exe.ps1).Path
          $packagesFile = (Resolve-Path ./packages.json).Path
          $outputDir = (Resolve-Path ./dist -ErrorAction SilentlyContinue).Path
          if (-not $outputDir) { New-Item -ItemType Directory -Path ./dist | Out-Null; $outputDir = (Resolve-Path ./dist).Path }
          Write-Host "Invoking: & $scriptPath -PackagesFile $packagesFile -OutputDir $outputDir -VerboseBuild"
          & $scriptPath -PackagesFile $packagesFile -OutputDir $outputDir -VerboseBuild

      - name: Compute EXE metadata and set outputs
        id: compute-metadata
        shell: pwsh
        run: |
          if (-not (Test-Path dist/vcredist-aio.exe)) { Write-Host "noexe=1" >> $env:GITHUB_OUTPUT; exit 0 }
          $exePath = (Resolve-Path ./dist/vcredist-aio.exe -ErrorAction Stop).Path
          $hash = (Get-FileHash -Algorithm SHA256 -Path $exePath).Hash
          $short = $hash.Substring(0,12)
          $sizeBytes = (Get-Item $exePath).Length
          $sizeMB = [math]::Round($sizeBytes / 1MB, 2)
          Write-Host "exe_sha=$hash" >> $env:GITHUB_OUTPUT
          Write-Host "exe_sha_short=$short" >> $env:GITHUB_OUTPUT
          Write-Host "exe_size_bytes=$sizeBytes" >> $env:GITHUB_OUTPUT
          Write-Host "exe_size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
          Write-Host "exe_path=$exePath" >> $env:GITHUB_OUTPUT
          Write-Host "Computed EXE metadata: SHA256=$hash, Size=${sizeMB}MB"

      - name: Upload SHA256SUMS.txt as artifact
        if: steps.compute-metadata.outputs.noexe != '1'
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: dist/SHA256SUMS.txt
          if-no-files-found: error

      - name: Upload EXE and checksum bundle
        if: steps.compute-metadata.outputs.noexe != '1'
        uses: actions/upload-artifact@v4
        with:
          name: vcredist-aio
          path: |
            dist/vcredist-aio.exe
            dist/SHA256.txt
          if-no-files-found: error

      - name: Create Release (with EXE metadata)
        if: steps.compute-metadata.outputs.noexe != '1'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: vcredist-aio-${{ github.run_number }}-${{ steps.compute-metadata.outputs.exe_sha_short }}
          name: VCRedist AIO ${{ steps.compute-metadata.outputs.exe_sha_short }}
          files: |
            dist/vcredist-aio.exe
            dist/SHA256SUMS.txt
          body: |
            ## VCRedist AIO Offline EXE
            - File: dist/vcredist-aio.exe
            - SHA256: ${{ steps.compute-metadata.outputs.exe_sha }}
            - Size: ${{ steps.compute-metadata.outputs.exe_size_mb }} MB

      - name: Final status
        shell: pwsh
        run: |
          if (Test-Path dist/vcredist-aio.exe) { Write-Host "Build succeeded and artifacts uploaded." } else { Write-Host "Build did not produce EXE; check logs."; exit 1 }