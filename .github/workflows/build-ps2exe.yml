name: Build PS2EXE Installer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PS2EXE
        shell: pwsh
        run: |
          Install-Module ps2exe -Scope CurrentUser -Force

      - name: Ensure required files are present
        shell: pwsh
        run: |
          if (-not (Test-Path automation/install.ps1)) {
            Write-Error "install.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }
          if (-not (Test-Path automation/uninstall.ps1)) {
            Write-Error "uninstall.ps1 is missing. Ensure it is committed to the repository."
            exit 1
          }

      - name: Ensure packages.json is present
        shell: pwsh
        run: |
          if (-not (Test-Path ./packages.json)) {
            Write-Error "packages.json is missing. Ensure it is committed to the repository."
            exit 1
          }

      - name: Debug workspace
        shell: pwsh
        run: |
          Write-Host "Current directory contents:"
          Get-ChildItem -Recurse

    #   - name: Prepare packages
    #     shell: pwsh
    #     run: |
    #       Write-Host "Preparing packages using build-nsis.ps1..."
    #       ./automation/build-nsis.ps1 -PackagesFile packages.json -OutputDir dist

      - name: Build EXE using PS2EXE
        shell: pwsh
        run: |
          Write-Host "Running PS2EXE build script..."
          ./automation/build-ps2exe.ps1 -PackagesFile ./packages.json -VerboseBuild

      - name: Validate build artifacts
        shell: pwsh
        run: |
          $files = @('dist/vcredist-aio.exe', 'dist/SHA256.txt')
          foreach ($f in $files) {
            if (-not (Test-Path $f)) {
              Write-Error "Required artifact missing: $f"
              exit 1
            }
          }
          Write-Host "âœ” All required artifacts present"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: vcredist-aio
          path: dist/vcredist-aio.exe
          if-no-files-found: error
