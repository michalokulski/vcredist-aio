name: Build Offline VCRedist AIO

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - update-**

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install NSIS
      - name: Install NSIS
        run: |
          try {
            choco install nsis -y --no-progress
            if ($LASTEXITCODE -ne 0) {
              throw "Chocolatey failed with exit code: $LASTEXITCODE"
            }
            
            # Verify NSIS is accessible
            $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
            if (-not (Test-Path $nsisPath)) {
              throw "NSIS executable not found at: $nsisPath"
            }
            
            $version = & $nsisPath /VERSION
            Write-Host "✔ NSIS installed successfully (version: $version)"
          } catch {
            Write-Error "Failed to install NSIS: $_"
            exit 1
          }

      - name: Build NSIS installer
        run: |
          pwsh -File automation/build-nsis.ps1 `
            -PackagesFile packages.json `
            -OutputDir dist

      - name: Create ZIP package (standalone script)
        run: |
          # Clean up any existing release-package directory
          if (Test-Path 'release-package') {
            Remove-Item -Path 'release-package' -Recurse -Force
          }
          
          # Create clean release structure
          $releaseDir = 'release-package'
          $packagesDir = Join-Path $releaseDir 'packages'
          
          New-Item -ItemType Directory -Path $releaseDir -Force | Out-Null
          New-Item -ItemType Directory -Path $packagesDir -Force | Out-Null
          
          # Copy packages
          Copy-Item -Path 'dist/packages/*' -Destination $packagesDir -Force
          
          # Copy standalone installer script
          Copy-Item -Path 'automation/install.ps1' -Destination $releaseDir -Force
          Copy-Item -Path 'automation/uninstall.ps1' -Destination $releaseDir -Force
          
          # Verify required files were copied
          $requiredFiles = @(
            (Join-Path $packagesDir "*.exe"),
            (Join-Path $releaseDir "install.ps1"),
            (Join-Path $releaseDir "uninstall.ps1")
          )
          
          foreach ($pattern in $requiredFiles) {
            if (-not (Test-Path $pattern)) {
              Write-Error "Required file(s) missing: $pattern"
              exit 1
            }
          }
          
          Write-Host "✔ All required files verified"
          
          # Create README for ZIP users
          $readmeContent = @"
          # VCRedist AIO Offline Installer
          
          ## Installation Instructions
          
          1. Extract this archive to a folder
          2. Right-click ``install.ps1`` → Run with PowerShell (as Administrator)
          3. Or run from command line:
             ``````powershell
             powershell -ExecutionPolicy Bypass -File install.ps1
             ``````
          
          ## Optional Parameters
          
          - Silent mode: ``install.ps1 -Silent``
          - Skip validation: ``install.ps1 -SkipValidation``
          - Package filtering: ``install.ps1 -PackageFilter "2022"``
          - Multiple filters: ``install.ps1 -PackageFilter "2019","2022"``
          
          ## Log Files
          
          Installation logs are saved to: ``vcredist-install-YYYYMMDD-HHMMSS.log``
          
          ## What's Inside
          
          This package contains official Microsoft Visual C++ Redistributables:
          - Visual C++ 2005 (x86/x64)
          - Visual C++ 2008 (x86/x64)
          - Visual C++ 2010 (x86/x64)
          - Visual C++ 2012 (x86/x64)
          - Visual C++ 2013 (x86/x64)
          - Visual C++ 2015-2022 (x86/x64)
          - Visual Studio Tools for Office Runtime (VSTOR)
          
          All packages are downloaded from official Microsoft sources via Winget manifests.
          "@
          
          $readmeContent | Out-File (Join-Path $releaseDir "README.txt") -Encoding UTF8
          
          # Create ZIP
          New-Item -ItemType Directory -Path artifact -Force | Out-Null
          Compress-Archive -Path "$releaseDir/*" -DestinationPath 'artifact/vc_redist_aio_offline.zip' -CompressionLevel Optimal -Force
          
          Write-Host "✔ ZIP package created"

      - name: Validate build artifacts
        run: |
          $files = @('dist/VC_Redist_AIO_Offline.exe', 'dist/SHA256.txt', 'artifact/vc_redist_aio_offline.zip')
          foreach ($f in $files) {
            if (-not (Test-Path $f)) {
              Write-Error "Required artifact missing: $f"
              exit 1
            }
          }
          Write-Host "✔ All required artifacts present"

      - name: Extract version for release name
        id: get-version
        run: |
          $packagesJson = Get-Content packages.json -Raw | ConvertFrom-Json
          $vcredist2015Plus = $packagesJson.packages | Where-Object { $_.id -eq "Microsoft.VCRedist.2015Plus.x64" }
          
          if ($vcredist2015Plus -and $vcredist2015Plus.version) {
            $version = $vcredist2015Plus.version
            Write-Host "Found version: $version"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "release_name=VCRedist AIO $version"
          } else {
            Write-Error "Could not find Microsoft.VCRedist.2015Plus.x64 version"
            exit 1
          }

      - name: Compute SHA256 for all assets
        id: compute-sha
        run: |
          $exeFile = 'dist/VC_Redist_AIO_Offline.exe'
          $zipFile = 'artifact/vc_redist_aio_offline.zip'
          
          $exeSha = (Get-FileHash -Algorithm SHA256 $exeFile).Hash
          $zipSha = (Get-FileHash -Algorithm SHA256 $zipFile).Hash
          
          Write-Host "EXE SHA256: $exeSha"
          Write-Host "ZIP SHA256: $zipSha"
          
          # Get file sizes
          $exeSize = [math]::Round((Get-Item $exeFile).Length / 1MB, 2)
          $zipSize = [math]::Round((Get-Item $zipFile).Length / 1MB, 2)
          
          # Create combined checksum file
          $checksumContent = @"
          $exeSha  VC_Redist_AIO_Offline.exe
          $zipSha  vc_redist_aio_offline.zip
          "@
          
          $checksumContent | Out-File 'artifact/SHA256SUMS.txt' -Encoding ASCII -Force
          
          # Output for release notes
          Add-Content -Path $env:GITHUB_OUTPUT -Value "exe_sha=$exeSha"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "zip_sha=$zipSha"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "exe_size=$exeSize"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "zip_size=$zipSize"

      - name: Generate release notes
        id: release-notes
        run: |
          $packagesJson = Get-Content packages.json -Raw | ConvertFrom-Json
          
          $notes = @"
          # VCRedist AIO Offline Installer
          
          ## Download Options
          
          | File | Size | SHA256 | Description |
          |------|------|--------|-------------|
          | **VC_Redist_AIO_Offline.exe** | ${{ steps.compute-sha.outputs.exe_size }} MB | ``${{ steps.compute-sha.outputs.exe_sha }}`` | **Recommended** - NSIS installer, one-click installation |
          | **vc_redist_aio_offline.zip** | ${{ steps.compute-sha.outputs.zip_size }} MB | ``${{ steps.compute-sha.outputs.zip_sha }}`` | PowerShell script + packages for manual control |
          
          ## Installation Instructions
          
          ### Option 1: NSIS Installer (Recommended)
          1. Download ``VC_Redist_AIO_Offline.exe``
          2. Run as Administrator
          3. The installer will automatically extract and install all packages
          4. Check log file in ``%TEMP%``: ``vcredist-install-YYYYMMDD-HHMMSS.log``
          
          **Silent Installation:**
          ``````cmd
          VC_Redist_AIO_Offline.exe /S
          ``````
          
          **Advanced Parameters:**
          ``````cmd
          # Extract files only (no installation)
          VC_Redist_AIO_Offline.exe /EXTRACT="C:\\ExtractPath"
          
          # Install specific packages only
          VC_Redist_AIO_Offline.exe /PACKAGES="2022,2019"
          
          # Custom log file location
          VC_Redist_AIO_Offline.exe /LOGFILE="C:\\Logs\\vcredist.log"
          
          # Skip hash validation (faster, less secure)
          VC_Redist_AIO_Offline.exe /SKIPVALIDATION
          
          # Prevent reboot flag
          VC_Redist_AIO_Offline.exe /NOREBOOT
          
          # Combine parameters
          VC_Redist_AIO_Offline.exe /S /PACKAGES="2022" /LOGFILE="C:\\Logs\\install.log"
          ``````
          
          **Parameter Details:**
          - `/S` - Silent mode (no UI)
          - `/EXTRACT="path"` - Extract files without installing
          - `/PACKAGES="list"` - Filter by years (2005,2008,2010,2012,2013,2015-2022)
          - `/LOGFILE="path"` - Custom log location
          - `/SKIPVALIDATION` - Skip SHA256 validation
          - `/NOREBOOT` - Don't set reboot flag
          
          ### Option 2: PowerShell Script (Advanced)
          1. Download and extract ``vc_redist_aio_offline.zip``
          2. Right-click ``install.ps1`` → Run with PowerShell (as Administrator)
          3. Optional flags:
             - ``-Silent``: Suppress console output
             - ``-SkipValidation``: Skip pre-installation checks (not recommended)
             - ``-PackageFilter``: Install only specific years (e.g., ``"2022"``, ``"2019,2015"``)
          
          **Examples:**
          ``````powershell
          # Silent installation
          powershell -ExecutionPolicy Bypass -File install.ps1 -Silent
          
          # Install only 2022 runtime
          powershell -ExecutionPolicy Bypass -File install.ps1 -PackageFilter "2022"
          
          # Install multiple specific years
          powershell -ExecutionPolicy Bypass -File install.ps1 -PackageFilter "2019","2022"
          ``````
          
          ## Included Packages
          
          | Package | Version |
          |---------|---------|
          "@
          
          foreach ($pkg in $packagesJson.packages) {
            $name = $pkg.id -replace 'Microsoft\.', ''
            $version = $pkg.version
            $notes += "`n| $name | $version |"
          }
          
          $notes += @"
          
          
          ## What's Inside
          
          - **Visual C++ 2005** (x86/x64)
          - **Visual C++ 2008** (x86/x64)
          - **Visual C++ 2010** (x86/x64)
          - **Visual C++ 2012** (x86/x64)
          - **Visual C++ 2013** (x86/x64)
          - **Visual C++ 2015-2022** (x86/x64) - **Unified runtime** (same packages for 2015/2017/2019/2022)
          - **Visual Studio Tools for Office Runtime (VSTOR)**
          
          **Note:** Visual C++ 2015-2022 all use the same redistributable. Filtering by years 2015, 2017, 2019, or 2022 will install the same packages.
          
          All packages are **official Microsoft redistributables** downloaded from Winget manifests.
          
          ## Why Choose This Over Other Solutions?
          
          ✅ **Automated Updates** - GitHub Actions check Winget daily for new versions  
          ✅ **Verifiable Sources** - All downloads from official Microsoft URLs  
          ✅ **Transparent** - Full source code on GitHub  
          ✅ **Modern Focus** - Optimized for Windows 10/11  
          ✅ **Multiple Formats** - Choose NSIS installer or PowerShell script  
          ✅ **No AV False Positives** - Uses industry-standard NSIS installer  
          
          **Benefits:**
          - ✅ Significantly lower false positive rate
          - ✅ Trusted by Windows Defender and major AV vendors
          - ✅ Professional installer UI
          - ✅ Better compression (smaller file size)
          - ✅ Industry-standard packaging
          
          ## Uninstaller
          
          The NSIS installer registers an uninstaller in Windows Apps & Features. You can also use the standalone uninstaller script:
          
          ``````powershell
          # Interactive mode (requires confirmation)
          .\\uninstall.ps1
          
          # Silent uninstall (requires -Force)
          .\\uninstall.ps1 -Force -Silent
          
          # Preview what would be removed
          .\\uninstall.ps1 -WhatIf
          ``````
          
          **Features:**
          - ✅ Automatic duplicate detection (fixes x86 packages appearing twice on 64-bit systems)
          - ✅ Architecture detection from display names
          - ✅ Safety confirmation (type "UNINSTALL" unless using `-Force`)
          - ✅ Comprehensive logging with exit code interpretation
          
          ## Log Files
          
          - Installation logs: ``vcredist-install-YYYYMMDD-HHMMSS.log`` (saved to ``%TEMP%``)
          - Uninstallation logs: ``vcredist-uninstall-YYYYMMDD-HHMMSS.log``
          
          Check the log files for detailed installation/uninstallation results and any errors.
          "@
          
          # Save to file
          $notes | Out-File 'release-notes.md' -Encoding UTF8 -Force
          Write-Host "Release notes generated"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.get-version.outputs.release_name }}
          tag_name: v${{ steps.get-version.outputs.version }}
          body_path: release-notes.md
          files: |
            dist/VC_Redist_AIO_Offline.exe
            artifact/vc_redist_aio_offline.zip
            artifact/SHA256SUMS.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}