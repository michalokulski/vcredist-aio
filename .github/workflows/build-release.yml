name: Build Offline VCRedist AIO

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - update-**

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build installer
        run: |
          pwsh -File automation/build.ps1 `
            -PackagesFile packages.json `
            -OutputDir dist `
            -PSEXEPath powershell-to-exe.json

      - name: Validate build artifacts
        run: |
          $files = @('dist/VC_Redist_AIO_Offline.exe', 'dist/SHA256.txt')
          foreach ($f in $files) {
            if (-not (Test-Path $f)) {
              Write-Error "Required artifact missing: $f"
              exit 1
            }
          }
          Write-Host "✔ All required artifacts present"

      - name: Create ZIP archive
        run: |
          $sourceDir = 'dist'
          $zipPath = 'artifact/vc_redist_aio_offline.zip'
          
          New-Item -ItemType Directory -Path artifact -Force | Out-Null
          Compress-Archive -Path $sourceDir/* -DestinationPath $zipPath -Force
          
          Write-Host "✔ ZIP created: $zipPath"

      - name: Compute SHA256
        id: compute-sha
        run: |
          $file = 'artifact/vc_redist_aio_offline.zip'
          if (Test-Path $file) {
            $sha = (Get-FileHash -Algorithm SHA256 $file).Hash
            Write-Host "Computed SHA256: $sha"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "sha=$sha"
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/VC_Redist_AIO_Offline.exe
            dist/SHA256.txt
            artifact/vc_redist_aio_offline.zip
          body: |
            # VCRedist AIO Offline Installer
            
            **SHA256 Checksums:**
            ```
            ${{ steps.compute-sha.outputs.sha }}  vc_redist_aio_offline.zip
            ```
            
            All Visual C++ Redistributables included:
            - 2005 (x86/x64)
            - 2008 (x86/x64)
            - 2010 (x86/x64)
            - 2012 (x86/x64)
            - 2013 (x86/x64)
            - 2015+ (x86/x64)
          tag_name: release-${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}